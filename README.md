# Dynamic-VM-allocation

#### ========== 20.12.2020 ==========

### Новый сценарий симуляции

Виртуальные машины продолжают приходить онлайн (по-одной), однако теперь каждому такому событию присвоено своё время. Так, между двумя соседними событиями прихода новой виртуальной машины проходит `t` единиц времени, где `t` выбирается равномерно на отрезке от 1 до `MAX_TIME_BETWEEN_EVENTS`. Таким образом при помощи последнего параметра можно изменять скорость потока приходящих виртуальных машин. Помимо времени попадания на сервер, для виртуальных машин задаётся время, в течение которого они будут работать. Соответственно, когда машина приходит на сервер, мы знаем время начала и конца её работы.

Теперь я решаю динамическую задачу, соответственно симуляция начинается с уже заполненными серверами и их загрузка либо остаётся постоянной или меняется согласно одному из выбранных сценариев. На данный момент на первой половине симуляции загрузка остаётся постоянной. Затем нагрузка резко падает в два раза (т. е. скорость прихода виртуальных машин становится меньше). Во время второй половины симуляции нагрузка так же остаётся неизменной. Таким образом, во время такой симуляции можно посмотреть, как различные алгоритмы справляются с постоянной нагрузкой, и насколько быстро они адаптируются к изменяющимся условиям.

Итоговая задача - минимизировать общее потребление энегрии кластером за время симуляции.

Ниже идут графики использования CPU, потребления энергии и числа активных хостов для двух алгоритмов. В качестве baseline-а используется (online) best-fit. Во втором случае я минимизирую то лишнее время, которое сервер будет дополнительно находиться в рабочем режиме, после добавления новой виртуальной машины. Иными словами, сначала я считаю для каждого сервера время `T_s`, когда все машины на нём прекратят работу. Затем я нахожу величину `VM_{end} - T_s > 0`, т. е. на сколько позже данная виртуальная машина завершит работу по сравнению с данным сервером, и минимизирую её. И, наконец, при прочих разных использую best-fit.

Данная техника позволяет системе быстро балансироваться при уменьшении нагрузки на облако, поскольку виртуальные машины с большими временами работы собираются на определённых серверах, соответственно остальные серверы быстрее освобождаются и переводятся в спящий режим. В то же время any-fit алгоритмы адаптируются гораздо медленее, поскольку никак не учитывают продолжительность времени работы виртуальных машин.

[!][slide_20_12_1](images/cpu_util_20_12.png)

[!][slide_20_12_2](images/current_energy_20_12.png)

[!][slide_20_12_3](images/active_hosts_20_12.png)

### Симуляции перенесены в jupyter (painter.ipynb)

#### ========== 29.11.2020 ==========

### Новые параметры симуляции
Новая симуляционная модель, теперь как виртуальные, так и физические машины имеют реалистичные параметры. В качестве примеров виртуальных машин я выбрал группу `General Computing-plus C6 ECS`, которые пакуются на серверы `General Computing S6_pro`.

Параметры виртуальных машин: https://www.huaweicloud.com/intl/en-us/product/ecs.html

Параметры хостов: https://www.huaweicloud.com/intl/en-us/pricing/index.html?tab=detail#/deh (bandwidth не нашёл, а потому поставил его 700 Gbit/s).

Главное достоинства выбора именно таких параметров заключается в том, что все три ресурса (CPU, RAM, bandwidth) потребляются примерно на одном уровне, потому решаемая задача решается 1-d подходами несколько хуже. Соответственно, понятна мотивация решать именно vector packing, а не обычный bin packing.

### Новые алгоритмы

http://ilanrcohen.droppages.com/pdfs/FracOnVBinPack.pdf

Для начала The f-restricted First Fit Algorithm. Небольшая модификация first fit, в которой запрещается делать корзины с большим дизбалансом. Пока стоит `f(x, y, z) = |max(x, y, z)| - |min(x, y, z)| < K`, но даже сейчас работает стабильно лучше обычного first fit или best fit.

Randomized Sliding Window Assignment - алгоритм с заумным выводом асимптотической оценки. Сам алгоритм работает, асимптотичесую оценку выполняет, но работает непозволительно плохо на фоне остальных подходов. Вообще этот пример показывает, что в bin packing теоретические статьи зачастую плохо связаны с практикой.

http://zhenxiao.com/papers/tpds2012.pdf

Minimizing skewness

Несмотря на то, что статья фокусируется на работе с дешевыми тарифами, там есть хорошая метрика skewness, т. е. отклонение потребления некоторого ресурса от среднего. Минимизация такого отклонения даёт возможность исключить дизбаланс в потреблении отдельных ресурсов. В 90% случаев работает лучше всего остального.

И, наконец, сравнение алгоритмов при заполнении датацентра 10000 виртуальными машинами:

<img src="Images/29_11_comparsion.png" width="450" height="300">

#### ========== 22.11.2020 ==========
Добавлены 4 основные эвристики (next-fit, first-fit, best-fit, worst-fit). Доступна слеующая симуляция: генерируется 1000 реальных и 2000 виртуальных машин, виртуальные машины помещаются на серверы при помощи одной из эвристик (без миграций, по одной), считается потребление энергии, время работы, число задействованных хостов и т.д.

`generator.py` - генерирует .json файл с параметрами симуляции

`simulator.py` - собственно, сама симуляция

`python3 generator.py` - сгенерировать синтетические данные

Запустить симуляцию можно так:
```
  >>> python3 simulator.py next-fit 
  Total time: 0.006s
  Total cumulative energy: 4.505^+06
  Total hosts active: 857
  Total VMs allocated: 2000
  CPU global utilization: 0.67449
  RAM global utilization: 0.67566
```
Ещё есть варианты `first-fit`, `best-fit`, `worst-fit`
